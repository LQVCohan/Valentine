<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>14/02 üíò For Ginn</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Pacifico&display=swap"
      rel="stylesheet">

    <style>
    :root{
      /* B·∫£ng m√†u tinh ch·ªânh l·∫°i: D·ªãu m·∫Øt v√† sang tr·ªçng h∆°n */
      --primary: #ff3366; 
      --primary-light: #ff85a2;
      --primary-dark: #c01b4e;
      --accent: #ffebf0;
      
      /* Glassmorphism cao c·∫•p h∆°n */
      --glass: rgba(255, 255, 255, 0.65);
      --glass-border: rgba(255, 255, 255, 0.9);
      --glass-shadow: 0 12px 40px -5px rgba(255, 51, 102, 0.15);
      
      --text-main: #594a4e;
      --text-highlight: #d6336c;
      --radius: 28px;
    }

    *{box-sizing:border-box}
    
    body{
      margin:0;
      font-family: 'Nunito', sans-serif;
      color: var(--text-main);
      /* N·ªÅn gradient pastel nh·∫π nh√†ng */
      background: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
      background-image: linear-gradient(135deg, #fff0f3 0%, #ffe3ec 50%, #e3f2fd 100%);
      background-size: 400% 400%;
      animation: gradientBG 20s ease infinite;
      min-height: 100vh;
      overflow-x:hidden;
    }

    @keyframes gradientBG {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 51, 102, 0.2); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 51, 102, 0.5); }

    /* Hearts Background m·ªù ·∫£o h∆°n */
    .hearts{position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0;}
    .heart{
      position:absolute;
      width:20px;
      aspect-ratio:1;
      background: #ff8fb3;
      clip-path:path('M12 21C11 20 3 14 3 8a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 6-8 12-9 13Z');
      opacity:0.3;
      animation:floatUp linear infinite;
    }
    @keyframes floatUp{
        0%{transform:translateY(110vh) scale(0.8); opacity:0;}
        20%{opacity:0.5;}
        100%{transform:translateY(-10vh) scale(1.1); opacity:0;}
    }

    .wrap{position:relative;z-index:2;max-width:1100px;margin:0 auto;padding:20px 20px 80px;}

    /* Header */
    header{
      position: sticky; top: 15px; z-index: 100;
      display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 24px;
      border-radius: 99px;
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.8);
      box-shadow: 0 4px 30px rgba(0,0,0,0.03);
      transition: all 0.3s ease;
    }
    header:hover { transform: translateY(-2px); background: rgba(255, 255, 255, 0.9); }

    .brand{display:flex;align-items:center;gap:12px;}
    .badge{
        display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;
        border-radius:50%; background: #ff3366;
        color:white;font-size:20px; box-shadow: 0 4px 12px rgba(255,51,102,0.3);
    }
    .brand-text { font-family: 'Pacifico', cursive; font-size: 22px; color: var(--primary-dark); }
    .tiny{display: block; font-family: 'Nunito', sans-serif; color:var(--text-main);font-size:12px; font-weight: 700;}

    /* Buttons */
    .btn{
        border:none; padding:12px 24px; border-radius:50px; cursor:pointer; font-weight:800; font-family: 'Nunito', sans-serif;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); display:inline-flex; align-items:center; gap:8px; font-size: 14px;
        letter-spacing: 0.3px;
    }
    .btn.primary{
        background: linear-gradient(135deg, #ff3366 0%, #ff5c8d 100%); color:white;
        box-shadow: 0 8px 20px -4px rgba(255, 51, 102, 0.4);
    }
    .btn.primary:hover{ transform: translateY(-3px) scale(1.02); box-shadow: 0 12px 25px -4px rgba(255, 51, 102, 0.5); }
    .btn.primary:active{ transform: scale(0.95); }
    
    .btn.ghost{ background: rgba(255,255,255,0.7); color: var(--text-highlight); border: 1px solid rgba(255,255,255,1); }
    .btn.ghost:hover{ background: #fff; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

    /* Cards */
    .card, .hero, .valCard {
        background: var(--glass);
        backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius);
        box-shadow: var(--glass-shadow);
        overflow: hidden;
        transition: transform 0.3s ease;
    }
    
    /* Hero Section Refined */
    .hero{
        margin-top:35px; display:grid; grid-template-columns: 1.1fr 0.9fr; gap:0;
        background: rgba(255,255,255,0.5);
    }
    @media (max-width: 820px){.hero{grid-template-columns:1fr; padding-bottom: 40px;}}

    .hero .left{padding: 40px 40px 50px;}
    .kicker{
        display:inline-block; padding:8px 18px; background: #fff0f3; 
        border-radius:20px; font-weight:800; color: var(--primary-dark); 
        font-size:12px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;
        border: 1px solid #ffdeeb;
    }
    
    /* FIX H1: ƒê·∫πp h∆°n, d·ªÖ ƒë·ªçc h∆°n */
    h1 {
        font-family: 'Pacifico', cursive; 
        font-size: clamp(36px, 6vw, 58px);
        margin: 5px 0 20px; 
        line-height: 1.25;
        color: #d61c4e; /* M√†u h·ªìng ƒë·∫≠m solid */
        text-shadow: 3px 3px 0px #fff, 0px 4px 15px rgba(214, 28, 78, 0.15); /* T·∫°o kh·ªëi v√† b√≥ng nh·∫π */
        position: relative;
        z-index: 2;
    }

    .sub{font-size: 17px; line-height: 1.7; color: #555; margin-bottom: 30px; max-width: 90%;}
    .chips{display:flex; gap:10px; flex-wrap:wrap; margin-top: 25px;}
    .chip{background: #fff; border:1px solid #ffeef2; padding:8px 16px; border-radius:20px; color: var(--primary); font-weight:700; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);}

    .hero .right{
        position:relative; min-height:320px; display:flex; align-items:center; justify-content:center;
    }
    
    /* FIX TEDDY: SVG G·∫•u d·ªÖ th∆∞∆°ng h∆°n */
    .teddy-scene { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }
    .teddy-svg { width: 280px; height: auto; filter: drop-shadow(0 15px 25px rgba(180, 50, 80, 0.15)); animation: floatBear 4s ease-in-out infinite; }
    .heart-float { position: absolute; font-size: 24px; animation: floatHearts 3s ease-in infinite; opacity: 0; }
    
    @keyframes floatBear { 0%,100%{transform:translateY(0) rotate(-2deg)} 50%{transform:translateY(-20px) rotate(2deg)} }
    @keyframes floatHearts { 0%{transform:translateY(0);opacity:0} 20%{opacity:1} 100%{transform:translateY(-80px);opacity:0} }

    .heroNote{
        position:absolute; bottom:25px; left:50%; transform: translateX(-50%);
        background: #fff; padding:8px 20px; border-radius:30px;
        font-size: 13px; color: var(--primary-dark); font-weight: 700; text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08); border: 1px solid #ffeeee; white-space: nowrap;
    }

    /* Grid Layout */
    .grid{margin-top:30px; display:grid; grid-template-columns:1fr 1fr; gap:24px;}
    @media (max-width: 820px){.grid{grid-template-columns:1fr}}

    .card { padding: 30px; }
    .card h2 { 
        font-family: 'Pacifico', cursive; color: var(--primary-dark); margin: 0 0 10px; font-size: 28px; 
    }
    .card p { color: #666; font-size: 15px; margin-bottom: 25px; line-height: 1.6; }

    /* Gallery Polish */
    .gallery{ display:grid; grid-template-columns:repeat(3,1fr); gap:15px; }
    .shot{
        width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:12px;
        cursor:pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: 4px solid #fff; /* Hi·ªáu ·ª©ng khung ·∫£nh */
        background: #fff;
    }
    .shot:hover{ transform: scale(1.08) rotate(-2deg); z-index: 2; box-shadow: 0 15px 30px rgba(0,0,0,0.15); border-color: #fff0f5; }

    /* Candy Jar */
    .jarWrap{ display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 20px; }
    .candyOut{
        background: #fff; padding: 15px 25px; border-radius: 20px; border: 2px dashed #ffccdd;
        text-align: center; font-weight: 800; color: var(--text-highlight); min-height: 60px;
        display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(255,240,245,0.5);
    }
    .shake { animation: shakeJar 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shakeJar { 10%, 90% { transform: translate3d(-1px, 0, 0) rotate(-2deg); } 20%, 80% { transform: translate3d(2px, 0, 0) rotate(2deg); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0) rotate(-4deg); } 40%, 60% { transform: translate3d(4px, 0, 0) rotate(4deg); } }

    /* Game Area */
    .game { background: #fff; padding: 20px; border-radius: 24px; border: 1px solid #fff5f8; box-shadow: inset 0 0 20px rgba(0,0,0,0.01); }
    .playfield {
        background: radial-gradient(circle at center, #fffbfc 0%, #fff0f5 100%);
        border: 2px solid #fff; 
        border-radius: 16px;
    }
    .tapHeart { 
        display:grid; place-items:center; font-size: 32px; line-height:1;
        user-select:none; filter: drop-shadow(0 4px 6px rgba(255,50,100,0.25)); 
        transition: transform 0.1s;
    }
    .tapHeart:active { transform: scale(0.9); }
    .tapHeart.missed { pointer-events: none; opacity: 0.75; }

    /* Letter */
    .valCardWrap { margin-top: 40px; }
    .valCard { padding: 0; border: 1px solid rgba(255,255,255,0.8); }
    .valTop { padding: 25px; background: rgba(255,255,255,0.6); border-bottom: 1px solid rgba(255,255,255,0.5); display: flex; justify-content: space-between; align-items: center; }
    
    .seal {
        width: 54px; height: 54px; background: linear-gradient(135deg, #ff3366, #ff6b8b);
        color: white; border-radius: 50%; display: grid; place-items: center; font-size: 26px;
        box-shadow: 0 8px 20px rgba(255, 51, 102, 0.3); border: 3px solid #fff;
    }

    .valBody { padding: 40px; background: rgba(255,250,252,0.5); }

    .envelope {
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
        background: linear-gradient(135deg, #fff5f8 0%, #ffebf2 100%);
    }
    .envSealWax {
        background: radial-gradient(circle at 35% 35%, #e11d48, #be123c);
        box-shadow: 0 4px 10px rgba(0,0,0,0.2), inset 0 2px 5px rgba(255,255,255,0.4);
        border: 1px solid #9f1239;
    }
    
    .letter { 
        font-family: 'Nunito', sans-serif; 
        background-color: #fff;
        background-image: repeating-linear-gradient(#fff 0px, #fff 24px, #e5e5e5 25px);
        line-height: 25px;
        padding: 30px; 
        border: 1px solid #eee;
    }
    .letter h3 { font-family: 'Pacifico', cursive; font-size: 24px; margin-bottom: 20px; color: var(--primary-dark); background: none; }
    .letter p { margin-bottom: 25px; color: #444; font-weight: 600; font-size: 15px; }

    /* Inputs */
    .pwRow { display:flex; gap:12px; margin-top: 25px; }
    .inp {
        flex:1; padding: 14px 24px; border-radius: 50px; border: 2px solid #ffdae5;
        outline: none; font-size: 16px; font-weight: 700; color: var(--primary-dark); background: rgba(255,255,255,0.8);
        transition: all 0.3s;
    }
    .inp:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(255, 51, 102, 0.1); background: #fff; }

    /* Modal */
    .backdrop { background: rgba(50, 20, 30, 0.4); backdrop-filter: blur(8px); }
    .dialog {
        border-radius: 28px; border: 1px solid rgba(255,255,255,1);
        box-shadow: 0 40px 60px -10px rgba(0, 0, 0, 0.15);
        background: #fff;
    }
    .dialogTop h3 { font-family: 'Pacifico', cursive; font-size: 26px; color: var(--primary); }
    .close { background: #f5f5f5; color: #888; transition: all 0.2s; font-weight: bold;}
    .close:hover { background: #ffe0e6; color: #d6336c; }

    .fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(30px); }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

    </style>
  </head>

  <body>
    <div class="hearts" id="bgHearts" aria-hidden="true"></div>
    <div class="confetti" id="confetti" aria-hidden="true"></div>

    <div class="wrap">
      <header class="fade-in-up" style="animation-delay: 0.1s">
        <div class="brand">
          <div class="badge">üíò</div>
          <div>
            <div class="brand-text">Valentine 14/02</div>
            <div class="tiny">G·ª≠i Ginn xinh ƒë·∫πp ‚Äî t·ª´ <b>Cohan</b> ‚ù§Ô∏è</div>
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" id="btnSurprise">üéÅ M·ªü qu√†</button>
          <button class="btn ghost" id="btnMusic">üéµ B·∫≠t nh·∫°c</button>
          <button class="btn ghost" id="btnReset">‚ôªÔ∏è Reset</button>
        </div>
      </header>

      <section class="hero fade-in-up" style="animation-delay: 0.2s"
        aria-label="L·ªùi ch√∫c">
        <div class="left">
          <div class="kicker">‚ú® M·ªôt chi·∫øc web nh·ªè cho em</div>
          <h1>Ch√∫c em m·ªôt Valentine th·∫≠t ng·ªçt ng√†o</h1>
          <h2> </h2>
          <p class="sub">
            Anh l√†m trang n√†y ƒë·ªÉ em v·ª´a xem ·∫£nh, v·ª´a ch∆°i v√†i tr√≤ vui vui,
            v√† quan tr·ªçng nh·∫•t l√†‚Ä¶ ƒë·ªÉ em bi·∫øt r·∫±ng <b>anh th∆∞∆°ng em r·∫•t
              nhi·ªÅu</b>.
          </p>
          <div class="actions" style="justify-content:flex-start">
            <button class="btn primary" id="btnLoveQuiz">üß† Quiz t√¨nh
              y√™u</button>
            <button class="btn ghost" id="btnCandy">üç¨ H≈© k·∫πo l·ªùi khen</button>
            <button class="btn ghost" id="btnGame">‚ù§Ô∏è B·∫Øt tim</button>
          </div>
          <div class="chips">
            <span class="chip">#em_r·∫•t_ƒë·∫∑c_bi·ªát</span>
            <span class="chip">#anh_lu√¥n_online</span>
            <span class="chip">#h√¥m_nay_em_xinh</span>
          </div>
        </div>
        <div class="right">
          <div class="teddy-scene" aria-hidden="true">
            <svg class="teddy-svg" viewBox="0 0 200 200"
              xmlns="http://www.w3.org/2000/svg">
              <g transform="translate(100, 110)">
                <circle cx="-35" cy="-45" r="15" fill="#d97706" />
                <circle cx="35" cy="-45" r="15" fill="#d97706" />
                <circle cx="-35" cy="-45" r="7" fill="#fcd34d" />
                <circle cx="35" cy="-45" r="7" fill="#fcd34d" />
                <ellipse cx="0" cy="-10" rx="55" ry="48" fill="#fbbf24" />
                <circle cx="-20" cy="-15" r="5" fill="#374151" />
                <circle cx="20" cy="-15" r="5" fill="#374151" />
                <ellipse cx="-35" cy="-5" rx="8" ry="5" fill="#fca5a5"
                  opacity="0.6" />
                <ellipse cx="35" cy="-5" rx="8" ry="5" fill="#fca5a5"
                  opacity="0.6" />
                <ellipse cx="0" cy="5" rx="22" ry="16" fill="#fef3c7" />
                <ellipse cx="0" cy="0" rx="8" ry="5" fill="#451a03" />
                <path d="M-5 10 Q0 15 5 10" stroke="#451a03" stroke-width="2"
                  fill="none" />
                <ellipse cx="-40" cy="40" rx="15" ry="12" fill="#fbbf24"
                  transform="rotate(-20)" />
                <ellipse cx="40" cy="40" rx="15" ry="12" fill="#fbbf24"
                  transform="rotate(20)" />
                <path d="M0 30 C-20 10 -40 40 0 70 C40 40 20 10 0 30"
                  fill="#ff3366" stroke="#be123c" stroke-width="2" />
              </g>
              <text x="20" y="40" fill="#ff6b6b" font-size="20"
                class="heart-float" style="animation-delay:0s">‚ù§</text>
              <text x="160" y="60" fill="#ff6b6b" font-size="16"
                class="heart-float" style="animation-delay:1.5s">‚ù§</text>
            </svg>
          </div>
          <div class="heroNote">Tip: b·∫•m ‚ÄúM·ªü qu√†‚Äù ƒë·ªÉ nh·∫≠n b·∫•t ng·ªù nho nh·ªè
            üòö</div>
        </div>
      </section>

      <section class="grid">
        <div class="card fade-in-up" style="animation-delay: 0.3s"
          id="galleryCard">
          <h2>üì∏ Album ‚ÄúEm l√† ƒë·ªÉ y√™u th∆∞∆°ng‚Äù</h2>
          <p>B·∫•m v√†o ·∫£nh
            ƒë·ªÉ ph√≥ng to nh√©.</p>
          <div class="gallery" id="gallery">
            <img class="shot" src="·∫¢nh/01.jpg" alt="·∫¢nh 1"
              data-full="·∫¢nh/01.jpg"
              onerror="this.src='https://placehold.co/200x200/fff0f3/ff3366?text=Love';this.parentElement.style.display='block'">
            <img class="shot" src="·∫¢nh/02.jpg" alt="·∫¢nh 2"
              data-full="·∫¢nh/02.jpg"
              onerror="this.src='https://placehold.co/200x200/fff0f3/ff3366?text=You';">
            <img class="shot" src="·∫¢nh/03.jpg" alt="·∫¢nh 3"
              data-full="·∫¢nh/03.jpg"
              onerror="this.src='https://placehold.co/200x200/fff0f3/ff3366?text=So';">
            <img class="shot" src="·∫¢nh/04.jpg" alt="·∫¢nh 4"
              data-full="·∫¢nh/04.jpg"
              onerror="this.src='https://placehold.co/200x200/fff0f3/ff3366?text=Much';">
            <img class="shot" src="·∫¢nh/05.jpg" alt="·∫¢nh 5"
              data-full="·∫¢nh/05.jpg"
              onerror="this.src='https://placehold.co/200x200/fff0f3/ff3366?text=Bae';">
            <img class="shot" src="·∫¢nh/06.jpg" alt="·∫¢nh 6"
              data-full="·∫¢nh/06.jpg"
              onerror="this.src='https://placehold.co/200x200/fff0f3/ff3366?text=Cute';">
          </div>
        </div>

        <div class="card fade-in-up" style="animation-delay: 0.4s"
          id="candyCard">
          <h2>üç¨ H≈© k·∫πo l·ªùi khen</h2>
          <p>B·ªëc 1 vi√™n k·∫πo l√† nh·∫≠n 1 l·ªùi khen. L·∫Øc h≈© l√† k·∫πo ‚Äúr∆°i l·ªôp b·ªôp‚Äù
            ·ªü trong tim anh üò≥</p>

          <div class="jarWrap">
            <div class="jar" id="jar"
              style="width:140px;height:180px;position:relative;filter:drop-shadow(0 15px 15px rgba(0,0,0,0.15))">
              <svg viewBox="0 0 200 240" xmlns="http://www.w3.org/2000/svg"
                aria-label="H≈© k·∫πo">
                <defs>
                  <lineargradient id="gGlass" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0" stop-color="#ffffff" stop-opacity=".8" />
                    <stop offset=".5" stop-color="#ffffff" stop-opacity=".3" />
                    <stop offset="1" stop-color="#ffffff" stop-opacity=".6" />
                  </lineargradient>
                  <lineargradient id="gLid" x1="0" x2="1">
                    <stop offset="0" stop-color="#f43f5e" />
                    <stop offset="1" stop-color="#fb7185" />
                  </lineargradient>
                </defs>
                <rect x="50" y="18" rx="8" ry="8" width="100" height="34"
                  fill="url(#gLid)" />
                <rect x="58" y="8" rx="8" ry="8" width="84" height="24"
                  fill="url(#gLid)" opacity=".8" />
                <path
                  d="M55 58 C50 80, 45 110, 48 160 C51 206, 74 222, 100 224 C126 222, 149 206, 152 160 C155 110, 150 80, 145 58 Z"
                  fill="url(#gGlass)" stroke="rgba(255,255,255,.9)"
                  stroke-width="2" />
                <g opacity=".95">
                  <circle cx="78" cy="115" r="14" fill="#fb7185" stroke="#fff"
                    stroke-width="2" />
                  <circle cx="110" cy="130" r="14" fill="#f43f5e" stroke="#fff"
                    stroke-width="2" />
                  <circle cx="92" cy="150" r="14" fill="#fb7185" stroke="#fff"
                    stroke-width="2" />
                  <circle cx="120" cy="155" r="14" fill="#ffe4e6" stroke="#fff"
                    stroke-width="2" />
                  <circle cx="78" cy="170" r="14" fill="#f43f5e" stroke="#fff"
                    stroke-width="2" />
                  <circle cx="108" cy="178" r="14" fill="#fb7185" stroke="#fff"
                    stroke-width="2" />
                </g>
              </svg>
            </div>
          </div>
          <div style="height:20px"></div>
          <div class="candyOut" id="candyOut">B·∫•m ‚ÄúB·ªëc k·∫πo‚Äù ƒëi b√© üòö</div>
          <div class="actions" style="justify-content:center; margin-top:15px">
            <button class="btn primary" id="btnPickCandy">üç¨ B·ªëc k·∫πo</button>
            <button class="btn ghost" id="btnShakeJar">‚Üª L·∫Øc h≈©</button>
          </div>
        </div>

        <div class="card fade-in-up" style="animation-delay: 0.5s"
          id="quizCard">
          <h2>üß† Quiz t√¨nh y√™u</h2>
          <p>Tr·∫£ l·ªùi nhanh cho vui. Cu·ªëi quiz c√≥ ‚Äúph·∫ßn th∆∞·ªüng‚Äù nha!</p>
          <div class="actions"
            style="justify-content:flex-start; margin-top:10px">
            <button class="btn primary" id="btnStartQuiz">B·∫Øt ƒë·∫ßu ngay</button>
          </div>
        </div>

        <div class="card fade-in-up" style="animation-delay: 0.6s"
          id="gameCard">
          <h2>‚ù§Ô∏è Mini game: B·∫Øt tim</h2>
          <p>
            B·∫•m tim r∆°i xu·ªëng ƒë·ªÉ ghi ƒëi·ªÉm.
            <br />M·ªëc 30 tim s·∫Ω m·ªü <b>b√≠ m·∫≠t</b> trong t·∫•m thi·ªáp üíå
          </p>

          <div class="game">
            <div class="progressWrap"
              style="background:#fff0f5;border-radius:12px;padding:12px 14px;margin-bottom:15px;border:1px solid #ffd1e4">
              <div class="progressText" id="gameProgressText"
                style="font-weight:800;color:#d6336c;font-size:13px;margin-bottom:8px">Ti·∫øn
                ƒë·ªô: s·∫µn s√†ng b·∫Øt tim üíó</div>
              <div class="progressBar"
                style="height:12px;background:#fff;border-radius:99px;overflow:hidden;border:1px solid #ffdae5">
                <div class="progressFill" id="gameProgressFill"
                  style="height:100%;width:0%;background:linear-gradient(90deg,#ff4d8d,#ff86b4);transition:width .2s ease"></div>
              </div>
            </div>
            <div class="gameTop"
              style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:15px;flex-wrap:wrap">
              <div class="score" id="score"
                style="font-weight:900;color:#fff;background:#ff3366;padding:6px 16px;border-radius:99px;box-shadow:0 4px 10px rgba(255,51,102,0.3)">ƒêi·ªÉm:
                0</div>
              <div class="rank" id="rank"
                style="font-weight:800;color:#555;font-size:13px">Danh hi·ªáu:
                Ch∆∞a ch∆°i</div>
              <div class="misses" id="misses"
                style="font-weight:800;color:#ef4444;font-size:13px">L·ª° h·ª•t:
                0/10</div>
              <div class="actions" style="justify-content:flex-start">
                <button class="btn primary"
                  style="padding:8px 18px;font-size:13px"
                  id="btnPlay">Ch∆°i</button>
                <button class="btn ghost"
                  style="padding:8px 18px;font-size:13px"
                  id="btnStop">D·ª´ng</button>
              </div>
            </div>
            <div class="playfield" id="playfield"
              style="position:relative;height:300px;border-radius:16px;overflow:hidden;">
            </div>
          </div>
        </div>
      </section>

      <section class="valCardWrap fade-in-up" style="animation-delay: 0.7s"
        id="letterCard">
        <div class="valCard">
          <div class="valTop">
            <div style="display:flex;gap:16px;align-items:center">
              <div class="seal">üíå</div>
              <div>
                <div style="font-weight:800;color:#b01b4c;font-size:20px">Thi·ªáp
                  b√≠ m·∫≠t</div>
                <div class="tiny" style="color:#777">Nh·∫≠p ƒë√∫ng m·∫≠t kh·∫©u ƒë·ªÉ m·ªü
                  thi·ªáp nh√© üòö</div>
              </div>
            </div>
            <button class="btn ghost" id="btnScrollGame">üéÆ Game</button>
          </div>

          <div class="valBody">
            <div class="envelope" aria-label="Thi·ªáp v√† phong th∆∞"
              style="position:relative;height:240px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,0.8)">
              <div class="envPaper"
                style="position:absolute;inset:0;background:linear-gradient(135deg, rgba(255,255,255,.4) 0%, rgba(255,255,255,0.1) 100%);pointer-events:none;"></div>

              <div class="envBody"
                style="position:absolute;inset:0;z-index:3;pointer-events:none;">
              </div>
              <div class="envFlap"
                style="position:absolute;left:50%;top:0;z-index:6;transform:translateX(-50%);width:100%;height:70%;clip-path:polygon(50% 100%, 0 0, 100% 0);background:linear-gradient(180deg, #fff 0%, #fff0f5 100%);border-bottom:1px solid rgba(0,0,0,0.05);transition:all 0.6s ease"></div>

              <div class="envSealWax" aria-hidden="true"
                style="position:absolute;left:50%;top:44%;z-index:7;transform:translate(-50%,-50%);width:56px;height:56px;border-radius:50%;display:grid;place-items:center;color:#fff;font-size:26px;transition:all 0.5s ease">‚ù§</div>

              <div class="letter" id="letter"
                style="position:absolute;left:15px;right:15px;bottom:15px;top:15px;border-radius:6px;z-index:4;box-shadow:0 10px 30px rgba(0,0,0,0.1);transform:translateY(120%);opacity:0;transition:transform 0.8s cubic-bezier(.2,.9,.2,1), opacity 0.5s ease; overflow-y:auto;">
                <h3>L√° th∆∞ d√†nh cho em üíó</h3>
                <p id="letterMain">
                  üíå Ch√†o em c√¥ g√°i b√© b·ªèng c·ªßa anh.<br /><br />
                  ü•∫ M·ªü ƒë∆∞·ª£c b·ª©c th∆∞ n√†y ch·∫Øc c≈©ng kh√≥ khƒÉn l·∫Øm he, xin l·ªói v√¨
                  ƒë√£ bi·∫øt em ƒëang m·ªát m√† c√≤n l√†m kh√≥ em ƒë·∫øn v·∫≠y.<br /><br />
                  üéÅ Th·∫≠t s·ª± th√¨ ƒë√¢y l√† m√≥n qu√† anh l√†m ra ƒë·ªÉ t·∫∑ng cho em v√† ƒë√¢y
                  c≈©ng l√† l·∫ßn ƒë·∫ßu ti√™n anh l√†m m·ªôt m√≥n qu√† nh∆∞ v·∫≠y (ch·∫Øc l√† v√¨
                  em c≈©ng h·ªçc IT gi·ªëng anh).<br /><br />
                  üå§Ô∏è Anh bi·∫øt nh·ªØng ng√†y n√†y em ƒëang r·∫•t m·ªát, r·∫•t kh√≥ ch·ªãu v√†
                  c≈©ng c√≥ th·ªÉ stress n·ªØa, nh∆∞ng b√™n c·∫°nh ƒë√≥ anh v·∫´n mong em s·∫Ω
                  t√¨m ƒë∆∞·ª£c nh·ªØng th√∫ vui trong cu·ªôc s·ªëng, c√≥ l·∫Ω nh·ªù v·∫≠y m√† em s·∫Ω
                  b·ªõt qu·∫°o anh h∆°n chƒÉng?<br /><br />
                  üíó Anh kh√¥ng t·ªè t√¨nh ·ªü ƒë√¢y v√¨ anh bi·∫øt em s·∫Ω tr·∫£ l·ªùi th·∫ø
                  n√†o... tuy nhi√™n th∆∞∆°ng em l√† ƒëi·ªÅu anh kh√¥ng l∆∞·ªùng tr∆∞·ªõc v√†
                  anh c≈©ng kh√¥ng ch√™ ƒëi·ªÅu ƒë√≥.<br /><br />
                  üóìÔ∏è C√≥ l·∫Ω nƒÉm nay l√† nƒÉm valentine ƒë√°ng nh·ªõ nh·∫•t c·ªßa anh -
                  ng√†y m√† anh ch√¢n th√†nh vi·∫øt nh·ªØng c√¢u t·ª´ n√†y cho
                  em.<br /><br />
                  ‚ú® C√≤n nhi·ªÅu th·ª© anh mu·ªën n√≥i n·ªØa nh∆∞ng th√¥i ƒë·ª£i ƒë·∫øn khi anh
                  ƒë·∫øn b√™n em ƒëi r·ªìi n√≥i sau v·∫≠y.<br /><br />
                  üå∏ Ch√∫c em h√¥m nay s·∫Ω th·∫≠t vui v·∫ª v√† h·∫°nh ph√∫c nh√©, dƒ© nhi√™n
                  l√† kh√¥ng ch·ªâ h√¥m nay.<br /><br />
                  ü§ç C·∫£m ∆°n em v√¨ ƒë√£ cho anh c·∫£m gi√°c ƒë∆∞·ª£c quan t√¢m v√† chi·ªÅu
                  chu·ªông.<br /><br />
                  ‚ù§Ô∏è Love u Ginn.
                </p>

                <div class="secret" id="secretBox"
                  style="margin-top:15px;padding:20px;border-radius:12px;background:#fff5f8;border:1px dashed #ff4d8d;display:none">
                  <div class="secretTitle"
                    style="font-weight:900;color:#d6336c;margin-bottom:6px">üîê
                    B√≠ m·∫≠t (m·ªü khi ƒë·∫°t 30 tim)</div>
                  <div style="color:#555;font-weight:600;line-height:1.6">
                    <b>ü§´ B√≠ m·∫≠t c·ªßa anh:</b><br />
                    B√≠ m·∫≠t c·ªßa anh ch√≠nh l√† ·∫£nh c·ªßa em anh ch∆∞a x√≥a :&gt; sao
                    x√≥a ƒë∆∞·ª£c kho b√°u c·ªßa anh ch·ª© hehe üì∏üíé
                  </div>
                </div>
              </div>

              <style>
             .envBody:before, .envBody:after {
                 content:""; position:absolute; bottom:0; width:54%; height:80%;
                 background: linear-gradient(165deg, #fff0f6, #ffe4ef);
                 box-shadow: -2px -2px 10px rgba(0,0,0,0.03);
             }
             .envBody:before { left:0; transform-origin: bottom left; transform: skewY(15deg); border-top-left-radius: 8px; }
             .envBody:after { right:0; transform-origin: bottom right; transform: skewY(-15deg); border-top-right-radius: 8px; }
             
             .envelope.opened { cursor: pointer; }
             .envelope.opened .envFlap { transform: rotateX(180deg); z-index: 1; opacity: 0; }
             .envelope.opened .envSealWax { opacity:0; transform: scale(1.5); pointer-events:none }
             .letter.peek { transform: translateY(56%); opacity:1; z-index: 5; pointer-events:none; overflow:hidden; }
            </style>
            </div>

            <div class="pwRow">
              <input class="inp" id="pw" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..."
                autocomplete="off" />
              <button class="btn primary" id="btnOpenLetter">M·ªü thi·ªáp</button>
            </div>

            <div class="unlockReq" id="unlockReq"
              style="margin-top:20px;padding:20px;border-radius:20px;background:rgba(255,255,255,0.7);border:1px solid #fff;">
              <div class="title"
                style="font-weight:800;color:#d6336c;margin-bottom:12px">ƒêi·ªÅu
                ki·ªán m·ªü th∆∞ cu·ªëi:</div>
              <ul
                style="margin:0;padding-left:20px;color:#555;font-size:14px;line-height:2">
                <li id="reqPw">‚ùå Nh·∫≠p ƒë√∫ng m·∫≠t kh·∫©u</li>
                <li id="reqQuiz">‚ùå Ho√†n th√†nh quiz t·ªëi thi·ªÉu 4/5</li>
                <li id="reqCandy">‚ùå L·∫Øc h≈© t·ªõi khi r∆°i ƒë∆∞·ª£c ch√¨a kh√≥a</li>
                <li id="reqGame">‚ùå B·∫Øt tim ƒë·∫°t m·ªëc cu·ªëi (30/30)</li>
              </ul>
              <style>.unlockReq li.ok { color: #10b981; font-weight: 700; list-style-type: '‚úÖ  '; }</style>
            </div>
            <div class="hint"
              style="text-align:center;margin-top:20px;color:#999;font-size:13px;font-style:italic">G·ª£i
              √Ω: m·∫≠t kh·∫©u l√† th·ª© m√† anh bi·∫øt em s·∫Ω bi·∫øt - Th·ª© anh lu√¥n mu·ªën t·ª´
              em v√† ch·ªâ em ( 4 ch·ªØ nh√©, vi·∫øt th∆∞·ªùng kh√¥ng d·∫•u) üòå</div>
          </div>
        </div>
      </section>
    </div>

    <div class="modal" id="modal" role="dialog" aria-modal="true"
      aria-labelledby="modalTitle"
      style="position:fixed;inset:0;z-index:999;">
      <div class="backdrop" id="modalBackdrop"
        style="position:absolute;inset:0;"></div>
      <div class="dialog" role="document"
        style="position:relative;width:min(500px, 90vw);margin:15vh auto 0;padding:30px;animation:popd .3s cubic-bezier(0.34, 1.56, 0.64, 1);">
        <div class="dialogTop"
          style="display:flex;justify-content:space-between;margin-bottom:15px;align-items:center">
          <h3 id="modalTitle" style="margin:0">Modal</h3>
          <button class="close" id="modalClose" aria-label="ƒê√≥ng"
            style="width:36px;height:36px;border-radius:50%;border:none;cursor:pointer;font-size:16px">‚úï</button>
        </div>
        <div class="content" id="modalBody"
          style="color:#555;line-height:1.6"></div>
        <div class="foot"
          style="display:flex;justify-content:flex-end;margin-top:25px">
          <button class="btn primary" id="modalOk">OK</button>
        </div>
      </div>
      <style>
          .modal { display: none; }
          .modal.show { display: block; }
          @keyframes popd { from{transform:scale(0.9);opacity:0} to{transform:scale(1);opacity:1} }
      </style>
    </div>

    <style>
    .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:1000;display:none;}
    .confetti.show{display:block}
    .piece{position:absolute;width:10px;height:14px;transform:rotate(10deg);animation: confettiFall linear forwards;}
    @keyframes confettiFall{from{transform: translateY(-20px) rotate(0deg);opacity:1}to{transform: translateY(110vh) rotate(720deg);opacity:0}}
    
    /* Pop Effects */
    .pop{position:absolute;pointer-events:none;transform:translate(-50%,-50%);animation:popOut .6s ease-out forwards;z-index:10}
    @keyframes popOut{0%{opacity:1;transform:translate(-50%,-50%) scale(0.5)}100%{opacity:0;transform:translate(-50%,-100px) scale(1.5)}}
    .break{position:absolute;bottom:10px;transform: translateX(-50%);pointer-events:none;font-size:24px;animation: breakUp .8s ease-out forwards;}
    @keyframes breakUp{to{opacity:0;transform:translateX(-50%) translateY(-30px) rotate(20deg)}}
    </style>

    <script>
    const CARD_PASSWORD = "ngam";
    const PROGRESS_STORAGE_KEY = "valentine_progress_v1";
    
    // --- C·∫§U H√åNH √ÇM THANH OFFLINE (WEB AUDIO API) ---
    const AudioEngine = (()=>{
      let ctx = null;
      let master = null;
      let bgmTimer = null;
      let bgmPlaying = false;

      function ensureCtx(){
        if(!ctx){
          const AC = window.AudioContext || window.webkitAudioContext;
          if(!AC) return null;
          ctx = new AC();
          master = ctx.createGain();
          master.gain.value = 0.75;
          master.connect(ctx.destination);
        }
        if(ctx.state === 'suspended') ctx.resume().catch(()=>{});
        return ctx;
      }

      function tone({freq=440, type='sine', attack=0.01, decay=0.18, sustain=0.0001, duration=0.22, volume=0.25, when=0}){
        const ac = ensureCtx();
        if(!ac) return;
        const now = ac.currentTime + when;
        const osc = ac.createOscillator();
        const gain = ac.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, now);
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(volume, now + attack);
        gain.gain.exponentialRampToValueAtTime(sustain, now + duration + decay);
        osc.connect(gain);
        gain.connect(master);
        osc.start(now);
        osc.stop(now + duration + decay + 0.02);
      }

      function playSfx(name){
        switch(name){
          case 'pop':
            tone({freq:620,type:'triangle',duration:0.06,decay:0.08,volume:0.16});
            tone({freq:880,type:'triangle',duration:0.04,decay:0.09,volume:0.1,when:0.03});
            break;
          case 'win':
            [523,659,784,1047].forEach((f,i)=>tone({freq:f,type:'sine',duration:0.12,decay:0.15,volume:0.14,when:i*0.09}));
            break;
          case 'shake':
            tone({freq:170,type:'square',duration:0.08,decay:0.12,volume:0.13});
            tone({freq:120,type:'square',duration:0.08,decay:0.12,volume:0.1,when:0.08});
            break;
          case 'tada':
            [659,831,988].forEach((f,i)=>tone({freq:f,type:'sine',duration:0.15,decay:0.2,volume:0.15,when:i*0.1}));
            break;
          case 'wrong':
            tone({freq:320,type:'sawtooth',duration:0.15,decay:0.18,volume:0.14});
            tone({freq:220,type:'sawtooth',duration:0.16,decay:0.18,volume:0.12,when:0.09});
            break;
        }
      }

      function startBgm(){
        const ac = ensureCtx();
        if(!ac || bgmPlaying) return false;
        bgmPlaying = true;
        const seq = [523.25,659.25,783.99,659.25,587.33,659.25,698.46,783.99];
        let step = 0;
        bgmTimer = setInterval(()=>{
          const base = seq[step % seq.length];
          tone({freq:base,type:'triangle',duration:0.18,decay:0.2,volume:0.08});
          tone({freq:base/2,type:'sine',duration:0.2,decay:0.24,volume:0.05,when:0.02});
          step += 1;
        }, 260);
        return true;
      }

      function stopBgm(){
        bgmPlaying = false;
        if(bgmTimer){
          clearInterval(bgmTimer);
          bgmTimer = null;
        }
      }

      return { playSfx, startBgm, stopBgm, ensureCtx };
    })();

    function playSfx(name){
      AudioEngine.playSfx(name);
    }
    (function spawnBgHearts(){
      const wrap = document.getElementById('bgHearts');
      const n = 25; 
      for(let i=0;i<n;i++){
        const h = document.createElement('div');
        h.className = 'heart';
        const left = Math.random()*100;
        const dur = 15 + Math.random()*20;
        const delay = Math.random()*-30;
        h.style.left = left + 'vw';
        h.style.animationDuration = dur + 's';
        h.style.animationDelay = delay + 's';
        wrap.appendChild(h);
      }
    })();

    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody  = document.getElementById('modalBody');
    const modalOk    = document.getElementById('modalOk');
    const modalClose = document.getElementById('modalClose');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalDialog = modal.querySelector('.dialog');

    function showModal(title, html, {wide = false} = {}){
      modalTitle.textContent = title || "Th√¥ng b√°o";
      modalBody.innerHTML = html || "";
      modalDialog.style.width = wide ? 'min(760px, 94vw)' : 'min(500px, 90vw)';
      modal.classList.add('show');
      setTimeout(()=>modalOk.focus(), 10);
      playSfx('pop'); 
    }
    function hideModal(){ modal.classList.remove('show'); }
    modalOk.addEventListener('click', hideModal);
    modalClose.addEventListener('click', hideModal);
    modalBackdrop.addEventListener('click', hideModal);
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal.classList.contains('show')) hideModal(); });

    document.getElementById('btnSurprise').addEventListener('click', ()=>{
      playSfx('tada'); 
      showModal("üéÅ B·∫•t ng·ªù n√®!", `
        <div style="font-weight:800;color:#d6336c;margin-bottom:8px">B√© iu, em ch√≠nh th·ª©c nh·∫≠n ƒë∆∞·ª£c:</div>
        <ul style="list-style:none;padding:0">
          <li style="margin-bottom:5px">üß∏ 1 c√°i √¥m th·∫≠t ch·∫∑t ( online )</li>
          <li style="margin-bottom:5px">üçï 1 b·ªØa ƒÉn ngon ( imagine )</li>
          <li style="margin-bottom:5px">‚ù§Ô∏è V√† 1 ng∆∞·ªùi th∆∞∆°ng em r·∫•t nhi·ªÅu ( reality )</li>
        </ul>
        <div style="margin-top:15px;color:#888;font-size:13px;border-top:1px solid #eee;padding-top:10px">G·ª£i √Ω: ch∆°i ‚ÄúB·∫Øt tim‚Äù ƒë·ªÉ m·ªü b√≠ m·∫≠t trong thi·ªáp nha!</div>
      `);
      burstConfetti();
    });

    document.getElementById('gallery').addEventListener('click', (e)=>{
      const img = e.target.closest('img');
      if(!img) return;
      playSfx('pop');
      const src = img.getAttribute('data-full');
      showModal("üì∏ ·∫¢nh c·ªßa em", `<img src="${src}" alt="·∫¢nh" style="width:100%;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)" />`);
    });

    const compliments = [
      "H√¥m nay em xinh qu√° tr·ªùi lu√¥n üòç",
      "N·ª• c∆∞·ªùi c·ªßa em l√†m anh y·∫øu l√≤ng üò≥",
      "Nh·ªù c√≥ em, m·ªçi th·ª© ƒë·ªÅu nh·∫π nh√†ng h∆°n üíó",
      "Em ƒë√°ng y√™u ki·ªÉu‚Ä¶ tui thua ü•∫",
      "Em l√† ƒëi·ªÅu may m·∫Øn nh·∫•t c·ªßa anh üçÄ",
      "Gi·ªçng em nghe l√† th·∫•y b√¨nh y√™n r·ªìi üòö",
      "Em v·ª´a ƒë·∫πp v·ª´a gi·ªèi, ai m√† kh√¥ng m√™!",
      "Anh th∆∞∆°ng em nhi·ªÅu h∆°n c·∫£ h√¥m qua (m√† h√¥m qua ƒë√£ nhi·ªÅu l·∫Øm r·ªìi) üíû",
      "Em l√† ‚Äún√≥c nh√†‚Äù c·ªßa anh, d√π anh ·ªü ƒë√¢u üè°",
      "Em ∆°i, em l√†m anh nh·ªõ em qu√° ü•∞",
    ];
    const candyOut = document.getElementById('candyOut');
    const jar = document.getElementById('jar');
    let hasCandyKey = false;
    let shakeCount = 0;

    let quizPassed = false;
    let gameGoalReached = false;
    let bestHeartScore = 0;
    let letterOpened = false;

    const reqPw = document.getElementById('reqPw');
    const reqQuiz = document.getElementById('reqQuiz');
    const reqCandy = document.getElementById('reqCandy');
    const reqGame = document.getElementById('reqGame');

    function markReq(el, ok, text){
      el.textContent = `${ok ? '‚úÖ' : '‚ùå'} ${text}`;
      el.classList.toggle('ok', ok);
    }

    function refreshUnlockChecklist(isPwOk = false){
      markReq(reqPw, isPwOk, 'Nh·∫≠p ƒë√∫ng m·∫≠t kh·∫©u');
      markReq(reqQuiz, quizPassed, 'Ho√†n th√†nh quiz t·ªëi thi·ªÉu 4/5');
      markReq(reqCandy, hasCandyKey, 'L·∫Øc h≈© t·ªõi khi r∆°i ƒë∆∞·ª£c ch√¨a kh√≥a');
      markReq(reqGame, gameGoalReached, 'B·∫Øt tim ƒë·∫°t m·ªëc cu·ªëi (30/30)');
    }

    function saveProgress(){
      const payload = {
        hasCandyKey,
        shakeCount,
        quizPassed,
        gameGoalReached,
        bestHeartScore,
        letterOpened,
      };
      localStorage.setItem(PROGRESS_STORAGE_KEY, JSON.stringify(payload));
    }

    function loadProgress(){
      const raw = localStorage.getItem(PROGRESS_STORAGE_KEY);
      if(!raw) return;
      try{
        const data = JSON.parse(raw);
        hasCandyKey = Boolean(data.hasCandyKey);
        shakeCount = Number.isFinite(data.shakeCount) ? Math.max(0, data.shakeCount) : 0;
        quizPassed = Boolean(data.quizPassed);
        gameGoalReached = Boolean(data.gameGoalReached);
        bestHeartScore = Number.isFinite(data.bestHeartScore) ? Math.max(0, data.bestHeartScore) : 0;
        letterOpened = Boolean(data.letterOpened);
      }catch{
        localStorage.removeItem(PROGRESS_STORAGE_KEY);
      }
    }

    refreshUnlockChecklist(false);

    document.getElementById('btnPickCandy').addEventListener('click', ()=>{
      const msg = compliments[Math.floor(Math.random()*compliments.length)];
      candyOut.textContent = msg;
      playSfx('pop'); 
      burstConfetti(18);
    });
    document.getElementById('btnShakeJar').addEventListener('click', ()=>{
      jar.classList.remove('shake'); void jar.offsetWidth; jar.classList.add('shake');
      playSfx('shake');
      // shakeCount++;
      // const hitKey = !hasCandyKey && (shakeCount >= 5 && Math.random() < 0.35);
      // if(hitKey){
      //   hasCandyKey = true;
      //   candyOut.textContent = "üîë Ting! Em ƒë√£ l·∫Øc r∆°i ƒë∆∞·ª£c ch√¨a kh√≥a r·ªìi n√®!";
      //   playSfx('win');
      //   burstConfetti(22);
      // } else {
      //   candyOut.textContent = "L·∫Øc l·∫Øc‚Ä¶ k·∫πo r∆°i ra: " + compliments[Math.floor(Math.random()*compliments.length)];
      // }
      // refreshUnlockChecklist(pw.value === CARD_PASSWORD);
      saveProgress();
    });
    document.getElementById('btnCandy').addEventListener('click', ()=>{
      document.getElementById('candyCard').scrollIntoView({behavior:'smooth', block:'start'});
      setTimeout(()=>showModal("üç¨ H≈© k·∫πo l·ªùi khen", "K√©o xu·ªëng m·ªôt ch√∫t l√† th·∫•y h≈© k·∫πo nha em üòö"), 450);
    });

    const quiz = [
      { q: "Khi em bu·ªìn, anh ƒë√£ l√†m g√¨ tr∆∞·ªõc?", a: ["ƒê·ªët nh√† ng∆∞·ªùi l√†m em bu·ªìn", "Im l·∫∑ng cho em t·ª± x·ª≠", "ƒêi code ti·∫øp"], correct: 0 },
      { q: "M√≥n ‚Äúqu√†‚Äù anh mu·ªën t·∫∑ng em nh·∫•t l√†‚Ä¶", a: ["Th·ªùi gian + s·ª± quan t√¢m", "Anh", "C·∫£ hai (t·∫•t nhi√™n!)"], correct: 2 },
      { q: "ƒêi·ªÅu anh th√≠ch nh·∫•t ·ªü ƒë√¢y l√† ... ?", a: ["ƒê·ªì ƒÉn ngon", "ƒêi d·∫°o + n√≥i chuy·ªán c√πng em", "·ªû nh√† xem phim"], correct: 1 },
      { q: "Ai l√† ng∆∞·ªùi ƒë√°ng y√™u nh·∫•t v≈© tr·ª•?", a: ["Em","Anh","C√¥ h√†ng x√≥m"], correct: 0 },
      { q: "Ch·ªçn c√¢u ƒë√∫ng nh·∫•t:", a: ["Anh th∆∞∆°ng em", "Anh th∆∞∆°ng em r·∫•t nhi·ªÅu", "Anh th∆∞∆°ng em v√¥ h·∫°n"], correct: 2 },
    ];

    function runQuiz(){
      let idx = 0, qscore = 0;
      function render(){
        const item = quiz[idx];
        const buttons = item.a.map((txt,i)=>`
          <button class="btn ${i===0?'primary':'ghost'}" data-i="${i}" style="width:100%; justify-content:center; margin-bottom:8px">${txt}</button>
        `).join('');
        showModal(`üß† Quiz (${idx+1}/${quiz.length})`, `
          <div style="font-weight:900;color:#d6336c;margin-bottom:12px;font-size:16px">${item.q}</div>
          <div style="display:flex;flex-direction:column;">${buttons}</div>
          <div style="margin-top:10px;font-weight:700;color:#888;font-size:13px">ƒêi·ªÉm hi·ªán t·∫°i: ${qscore}</div>
        `);
        [...modalBody.querySelectorAll('button[data-i]')].forEach(b=>{
          b.addEventListener('click', ()=>{
            const chosen = Number(b.getAttribute('data-i'));
            if(chosen === item.correct) {
                qscore++;
                playSfx('pop');
            } else {
                playSfx('wrong');
            }
            idx++;
            if(idx >= quiz.length) finish();
            else render();
          });
        });
      }
      function finish(){
        quizPassed = qscore >= 4;
        refreshUnlockChecklist(pw.value === CARD_PASSWORD);
        saveProgress();
        burstConfetti();
        if(quizPassed) playSfx('win');
        showModal("üéâ K·∫øt qu·∫£!", `
          <div style="font-weight:900;color:#d6336c;font-size:18px">Em ƒë·∫°t ${qscore}/${quiz.length} ƒëi·ªÉm!</div>
          <div style="margin-top:8px;font-weight:800;color:${quizPassed ? '#10b981' : '#f43f5e'}">
            ${quizPassed ? '‚úÖ ƒê√£ ƒë·∫°t ƒëi·ªÅu ki·ªán quiz (>=4/5)' : '‚ùå Ch∆∞a ƒë·∫°t ƒëi·ªÅu ki·ªán quiz (c·∫ßn >=4/5)'}
          </div>
          <div style="margin-top:15px;color:#555"><b>Ph·∫ßn th∆∞·ªüng:</b> 1 c√°i √¥m + 1 l·ªùi nh·∫Øn:</div>
          <div style="margin-top:10px;background:#fff0f7;border:1px dashed #ff4d8d;border-radius:12px;padding:12px;font-weight:800;color:#d6336c">
            ‚ÄúEm l√† ƒëi·ªÅu anh tr√¢n tr·ªçng nh·∫•t. C·∫£m ∆°n em v√¨ ƒë√£ ·ªü ƒë√¢y.‚Äù üíó
          </div>
        `);
      }
      render();
    }
    document.getElementById('btnStartQuiz').addEventListener('click', runQuiz);
    document.getElementById('btnLoveQuiz').addEventListener('click', ()=>{
      document.getElementById('quizCard').scrollIntoView({behavior:'smooth', block:'start'});
      setTimeout(runQuiz, 450);
    });

    const playfield = document.getElementById('playfield');
    const scoreEl = document.getElementById('score');
    const rankEl = document.getElementById('rank');
    const missesEl = document.getElementById('misses');
    const gameProgressText = document.getElementById('gameProgressText');
    const gameProgressFill = document.getElementById('gameProgressFill');
    let playing = false;
    let score = 0;
    let misses = 0;
    let gameOver = false;
    let spawner = null;

    let secretUnlocked = false;
    const secretBox = document.getElementById('secretBox');
    const PROGRESS_TARGET = 30;

    function updateGameProgress(s, {persistAchievement = true} = {}){
      if(persistAchievement && s >= PROGRESS_TARGET) gameGoalReached = true;
      const visual = gameGoalReached ? PROGRESS_TARGET : s;
      const pct = Math.min(100, (visual / PROGRESS_TARGET) * 100);
      gameProgressFill.style.width = pct + '%';
      refreshUnlockChecklist(pw.value === CARD_PASSWORD);
      gameProgressText.textContent = gameGoalReached
        ? 'Ho√†n th√†nh! Em ƒë√£ ƒë·∫°t 30/30 tim v√† m·ªü b√≠ m·∫≠t üíå'
        : `Ti·∫øn ƒë·ªô m·ªü b√≠ m·∫≠t: ${s}/${PROGRESS_TARGET} tim`;
    }

    function setRank(s){
      const ranks = [
        [0,  "Ch∆∞a ch∆°i"],
        [1,  "T√¢n binh ƒë√°ng y√™u üê£"],
        [10, "Ng∆∞·ªùi th∆∞∆°ng chuy√™n c·∫ßn üíó"],
        [20, "Chuy√™n gia b·∫Øt tim üòé"],
        [30, "Ch·ªß nh√¢n tr√°i tim anh üèÜ"],
        [50, "Huy·ªÅn tho·∫°i t√¨nh y√™u ‚ú®"],
      ];
      let r = ranks[0][1];
      for(const [t,name] of ranks) if(s >= t) r = name;
      rankEl.textContent = "Danh hi·ªáu: " + r;
    }

    function milestoneCheck(s){
      if(s === 30){
        secretUnlocked = true;
        secretBox.classList.add('show');
        document.getElementById('letterCard').scrollIntoView({behavior:'smooth', block:'start'});
        burstConfetti(36);
        playSfx('win'); 
        saveProgress();
      }
    }

    function handleGameOver(){
      if(gameOver) return;
      gameOver = true;
      stopGame({
        showSummary:false,
        statusText:`B√© tr∆∞·ª£t ${misses}/10 tim r·ªìi n√® ü•∫ Game d·ª´ng l·∫°i ƒë·ªÉ √¥m b√© m·ªôt c√°i.`,
      });
      playSfx('wrong');
      showModal('üòø Ooops, thua m·∫•t r·ªìi!', `
        <div style="text-align:center">
          <div style="font-size:52px;line-height:1">üß∏üíî</div>
          <div style="margin-top:10px;font-weight:900;color:#d6336c;font-size:18px">Em ƒë√£ h·ª•t 10 tr√°i tim</div>
          <div style="margin-top:8px;color:#666">Kh√¥ng sao nha, b·∫•m <b>Ch∆°i</b> ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i v√°n m·ªõi üíó</div>
        </div>
      `);
    }

    function popAt(x,y,emoji){
      const p = document.createElement('div');
      p.className = 'pop';
      p.style.left = x + 'px';
      p.style.top  = y + 'px';
      p.innerHTML = `<span style="font-size:20px">${emoji}</span><span style="margin-left:4px;font-weight:900;color:#d6336c">+1</span>`;
      playfield.appendChild(p);
      p.addEventListener('animationend', ()=>p.remove());
    }

    function breakAt(x){
      const b = document.createElement('div');
      b.className = 'break';
      b.style.left = x + 'px';
      b.textContent = "üíî";
      playfield.appendChild(b);
      b.addEventListener('animationend', ()=>b.remove());
    }

    function spawnTapHeart(){
      const h = document.createElement('div');
      h.className = 'tapHeart';
      const x = Math.random()*(playfield.clientWidth - 40) + 20;
      const dur = 1.25 + Math.random()*1.55;
      h.style.left = (x-15) + 'px';
      h.style.top = '-40px';
      h.style.position = 'absolute';
      h.style.width = '34px';
      h.style.height = '34px';
      h.style.cursor = 'pointer';
      h.textContent = 'üíñ';
      h.style.animation = `fall ${dur}s linear forwards`;
      
      let hit = false;

      const clickHandler = (ev) => {
          if(hit || !playing || gameOver) return;
          hit = true;
          score++;
          bestHeartScore = Math.max(bestHeartScore, score);
          scoreEl.textContent = "ƒêi·ªÉm: " + score;
          updateGameProgress(score);
          setRank(score);
          // Fix t·ªça ƒë·ªô click n·∫øu d√πng touch
          const clientY = ev.touches ? ev.touches[0].clientY : ev.clientY;
          const rect = playfield.getBoundingClientRect();
          const relY = clientY - rect.top;
          
          popAt(x, relY, "‚ú®");
          burstConfetti(8);
          milestoneCheck(score);
          saveProgress();
          playSfx('pop');
          h.remove();
      };

      h.addEventListener('mousedown', clickHandler);
      h.addEventListener('touchstart', clickHandler, {passive: true});

      h.addEventListener('animationend', ()=>{
        if(!hit){
          h.classList.add('missed');
          breakAt(x);
          if(playing && !gameOver){
            misses += 1;
            missesEl.textContent = `L·ª° h·ª•t: ${misses}/10`;
            if(misses >= 10) handleGameOver();
          }
        }
        h.remove();
      });

      playfield.appendChild(h);
    }
    
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `
      @keyframes fall {
        from{transform: translateY(-40px) rotate(45deg);opacity:1}
        to{transform: translateY(340px) rotate(45deg);opacity:0.2}
      }
    `;
    document.head.appendChild(styleSheet);

    function startGame(){
      if(playing) return;
      playing = true;
      score = 0;
      misses = 0;
      gameOver = false;
      scoreEl.textContent = "ƒêi·ªÉm: 0";
      missesEl.textContent = "L·ª° h·ª•t: 0/10";
      updateGameProgress(0, {persistAchievement:false});
      setRank(0);
      spawner = setInterval(spawnTapHeart, 420);
      spawnTapHeart();
      gameProgressText.textContent = "Game ƒë√£ b·∫Øt ƒë·∫ßu! B·∫Øt tim li√™n t·ª•c nha b√© üòÜ";
      playSfx('tada');
    }

    function stopGame({showSummary = true, statusText = null} = {}){
      playing = false;
      if(spawner) clearInterval(spawner);
      spawner = null;
      [...playfield.querySelectorAll('.tapHeart')].forEach(n=>n.remove());
      gameProgressText.textContent = statusText || `Stopppp. Th√†nh t√≠ch: ${score} tim üíó`;
      if(showSummary) burstConfetti(22);
      saveProgress();
    }

    function openLetterFullModal(){
      const letterMain = document.getElementById('letterMain');
      const secretVisible = gameGoalReached
        ? `<div style="margin-top:14px;padding:14px;border-radius:12px;background:#fff5f8;border:1px dashed #ff4d8d;color:#555;line-height:1.7"><b style="color:#d6336c">ü§´ B√≠ m·∫≠t c·ªßa anh:</b><br/>B√≠ m·∫≠t c·ªßa anh ch√≠nh l√† ·∫£nh c·ªßa em anh ch∆∞a x√≥a :&gt; sao x√≥a ƒë∆∞·ª£c kho b√°u c·ªßa anh ch·ª© hehe üì∏üíé</div>`
        : '';
      showModal('üíå L√° th∆∞ d√†nh cho em', `
        <div style="max-height:50vh;overflow:auto;padding:16px;border-radius:14px;background:#fff;border:1px solid #ffe0ea;line-height:1.8;color:#444">
          ${letterMain.innerHTML}
          ${secretVisible}
        </div>
      `, {wide:true});
    }

    function setLetterPeekState(opened){
      envelope.classList.toggle('opened', opened);
      letter.classList.toggle('peek', opened);
      letter.classList.remove('open');
    }

    document.getElementById('btnPlay').addEventListener('click', startGame);
    document.getElementById('btnStop').addEventListener('click', stopGame);
    document.getElementById('btnGame').addEventListener('click', ()=>{
      document.getElementById('gameCard').scrollIntoView({behavior:'smooth', block:'start'});
      setTimeout(startGame, 450);
    });
    document.getElementById('btnScrollGame').addEventListener('click', ()=>{
      document.getElementById('gameCard').scrollIntoView({behavior:'smooth', block:'start'});
    });

    const pw = document.getElementById('pw');
    const letter = document.getElementById('letter');
    const envelope = document.querySelector('.envelope');
    envelope.addEventListener('click', ()=>{
      if(letterOpened) openLetterFullModal();
    });
    document.getElementById('btnOpenLetter').addEventListener('click', ()=>{
      const isPwOk = pw.value === CARD_PASSWORD;
      refreshUnlockChecklist(isPwOk);
      if(isPwOk && quizPassed && hasCandyKey && gameGoalReached){
        setLetterPeekState(true);
        letterOpened = true;
        saveProgress();
        burstConfetti(20);
        playSfx('win'); 
        openLetterFullModal();
      } else {
        playSfx('wrong');
        showModal("üîí Ch∆∞a m·ªü ƒë∆∞·ª£c th∆∞", "C·∫ßn nh·∫≠p ƒë√∫ng m·∫≠t kh·∫©u v√† ho√†n th√†nh ƒë·ªß 3 minigame ƒë·ªÉ m·ªü th∆∞ cu·ªëi nha em üíó");
      }
    });
    pw.addEventListener('input', ()=>refreshUnlockChecklist(pw.value === CARD_PASSWORD));
    pw.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') document.getElementById('btnOpenLetter').click(); });

    function applyProgressToUi(){
      if(hasCandyKey) candyOut.textContent = "üîë Em ƒë√£ c√≥ ch√¨a kh√≥a r·ªìi, m·ªü th∆∞ th√¥i n√†o!";
      scoreEl.textContent = "ƒêi·ªÉm: " + bestHeartScore;
      missesEl.textContent = "L·ª° h·ª•t: 0/10";
      setRank(bestHeartScore);
      updateGameProgress(bestHeartScore, {persistAchievement:false});
      if(gameGoalReached){
        secretUnlocked = true;
        secretBox.classList.add('show');
      }
      if(letterOpened){
        setLetterPeekState(true);
      }
      refreshUnlockChecklist(pw.value === CARD_PASSWORD);
    }

    function resetProgress(){
      playing = false;
      if(spawner) clearInterval(spawner);
      spawner = null;
      [...playfield.querySelectorAll('.tapHeart')].forEach(n=>n.remove());
      hasCandyKey = false;
      shakeCount = 0;
      quizPassed = false;
      gameGoalReached = false;
      bestHeartScore = 0;
      letterOpened = false;
      secretUnlocked = false;
      score = 0;
      misses = 0;
      gameOver = false;
      candyOut.textContent = "B·∫•m ‚ÄúB·ªëc k·∫πo‚Äù ƒëi em üòö";
      gameProgressFill.style.width = '0%';
      gameProgressText.textContent = 'Ti·∫øn ƒë·ªô: s·∫µn s√†ng b·∫Øt tim üíó';
      scoreEl.textContent = 'ƒêi·ªÉm: 0';
      missesEl.textContent = 'L·ª° h·ª•t: 0/10';
      setRank(0);
      secretBox.classList.remove('show');
      letter.classList.remove('peek');
      envelope.classList.remove('opened');
      pw.value = '';
      localStorage.removeItem(PROGRESS_STORAGE_KEY);
      refreshUnlockChecklist(false);
    }

    document.getElementById('btnReset').addEventListener('click', ()=>{
      showModal('‚ôªÔ∏è Reset th√†nh t√≠ch', 'B·∫Øt ƒë·∫ßu l·∫°i t·ª´ ƒë·∫ßu nha em üíó');
      resetProgress();
    });

    loadProgress();
    applyProgressToUi();

    let musicOn = false;
    const btnMusic = document.getElementById('btnMusic');
    btnMusic.addEventListener('click', async ()=>{
      try{
        AudioEngine.ensureCtx();
        if(!musicOn){
            const started = AudioEngine.startBgm();
            if(!started) throw new Error('Web Audio API kh√¥ng kh·∫£ d·ª•ng');
            musicOn = true;
            btnMusic.textContent = "‚è∏Ô∏è T·∫Øt nh·∫°c";
        } else{
            AudioEngine.stopBgm();
            musicOn = false;
            btnMusic.textContent = "üéµ B·∫≠t nh·∫°c";
        }
      }catch(e){
          console.error(e);
          showModal("‚ö†Ô∏è Kh√¥ng b·∫≠t ƒë∆∞·ª£c nh·∫°c", "Thi·∫øt b·ªã/tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ Web Audio API üò¢");
      }
    });

    function burstConfetti(count=30){
      const layer = document.getElementById('confetti');
      layer.innerHTML = "";
      layer.classList.add('show');
      const colors = ["#ff3366","#ff6699","#ff99cc","#ffccd5","#fff"];
      const W = window.innerWidth;
      const H = window.innerHeight;
      for(let i=0;i<count;i++){
        const p = document.createElement('div');
        p.className = 'piece';
        p.style.left = Math.random()*W + "px";
        p.style.top = (-20 - Math.random()*H*0.2) + "px";
        p.style.background = colors[Math.floor(Math.random()*colors.length)];
        p.style.animationDuration = (2 + Math.random()*2) + "s";
        p.style.animationDelay = (Math.random()*0.2) + "s";
        p.style.borderRadius = (2 + Math.random()*4) + "px";
        layer.appendChild(p);
        p.addEventListener('animationend', ()=> p.remove());
      }
      setTimeout(()=> layer.classList.remove('show'), 4000);
    }
    </script>
  </body>
</html>
